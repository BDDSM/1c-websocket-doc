.. _sphinx-chapter:
   
.. meta::
    :description: WebSocket клиент и сервер для 1С. Тест компоненты
    :keywords: 1С, WebSocket, test

.. meta::
    :http-equiv=Content-Type: text/html; charset=utf-8

=======================================
Полное тестирование
=======================================

.. index:: ВыполнитьПолноеТестированиеКомпоненты
.. function:: ВыполнитьПолноеТестированиеКомпоненты()
    
    Процедура выполняет полное тестирование всех функций компонента. Можно использовать как сквозной пример.

Листинг:

.. code-block:: bsl
   :linenos:

   Процедура ВыполнитьПолноеТестированиеКомпоненты()
        ПутьКомпоненты = "D:\websocket.dll";
	
        // ШАГ1. ТЕСТ КЛИЕНТА ЧЕРЕЗ ВНЕШНИЙ СЕРВИС
        АдресСервера = "wss://echo.websocket.org";
        
        Если НЕ ПодключитьВнешнююКомпоненту(ПутьКомпоненты, "websocket", ТипВнешнейКомпоненты.Native) Тогда
            СисИнфо = Новый СистемнаяИнформация;
            ОписаниеОшибки = НСтр("ru='Ошибка подключения компоненты ('") + СисИнфо.ТипПлатформы + "):
            |" + ОписаниеОшибки();
            
            ВызватьИсключение ОписаниеОшибки;
        КонецЕсли;
        
        Клиент = Новый("AddIn.WebSocket.Client");	
        
        Попытка
            Клиент.Подключиться(Объект.АдресСервера);						
        Исключение
            
            Описание = ОписаниеОшибки();
            ТекстОшибки =  Клиент.ОписаниеОшибки();
            
            ТекстОписания = Описание + ": " + ТекстОшибки;
            
            ВызватьИсключение ТекстОписания;
            
        КонецПопытки;
        
        
        Попытка
            Клиент.Подключиться(Объект.АдресСервера);						
        Исключение		
            ТекстОшибки =  Клиент.ОписаниеОшибки();
            
            Если найти(ТекстОшибки, "Подключение уже выполнено") = 0 Тогда
                
                ВызватьИсключение ТекстОписания;
                
            КонецЕсли;
            
        КонецПопытки;

        ДанныеОтправки = "ase1ЙЦУ";
        
        Клиент.Отправить(ДанныеОтправки);
        
        Данные = "";
        
        Принято = Клиент.Принять(0, Данные);
        
        Если НЕ Данные = ДанныеОтправки Тогда
            ВызватьИсключение "Приняты не те данные которые отправлены"; 
        КонецЕсли;
        
        Данные = "";
        Принято = Клиент.Принять(3000, Данные);
        
        Если Принято ИЛИ ЗначениеЗаполнено(Данные) Тогда
            ВызватьИсключение "Принято то что не дожно принматься";	
        КонецЕсли;
        
        Клиент.Отключиться();
        Клиент.Отключиться();
        
        Клиент = Неопределено;
        
        Сообщить("Тестирование Шаг 1. Успешно пройдено");
        
        // ШАГ 2. ТЕСТ СОБСТВЕННОГО СЕРВЕРА И СОБСТВЕННЫХ КЛИЕНТОВ
	
        АдресПодключения = "127.0.0.1";
        ПортПодключения = 9098;
        
        Сервер = Новый(Объект.ПрефиксКомпоненты  + "Server");	
        
        Попытка
            Сервер.Запустить(АдресПодключения, ПортПодключения);						
        Исключение
            
            Описание = ОписаниеОшибки();
            ТекстОшибки =  Сервер.ОписаниеОшибки();
            
            ТекстОписания = Описание + ": " + ТекстОшибки;
            
            ВызватьИсключение ТекстОписания;
            
        КонецПопытки;
        
        Клиент1 = Новый(Объект.ПрефиксКомпоненты  + "Client");	
        Клиент2 = Новый(Объект.ПрефиксКомпоненты  + "Client");	
        
        СтрокаПодключения  = СтрШаблон("ws://%1:%2", АдресПодключения, Формат(ПортПодключения, "ЧГ=0"));
        
        Попытка
            Клиент1.Подключиться(СтрокаПодключения+"/first");						
            Клиент2.Подключиться(СтрокаПодключения+"/testadr");						
        Исключение
            
            Сервер.Остановить();
            
            Описание = ОписаниеОшибки();
            ТекстОшибки =  Клиент1.ОписаниеОшибки();
            ТекстОшибки = ТекстОшибки+ Клиент2.ОписаниеОшибки();
            
            ТекстОписания = Описание + ": " + ТекстОшибки;
            
            ВызватьИсключение ТекстОписания;
            
        КонецПопытки;
        
        ТекстОтправки = "ase1ЙЦУ"; 
        
        Клиент1.Отправить("ase1ЙЦУ");
        
        Данные = "";
        ИДКлиента = 0;
        
        Принято = Сервер.Принять(0, ИДКлиента, Данные);
        
        Результат = Сервер.Отключить(ИдКлиента);
        
        Клиент1 = Неопределено;
        Клиент2 = Неопределено;
        Сервер = Неопределено;

   КонецПроцедуры